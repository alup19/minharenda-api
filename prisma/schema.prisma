generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Unidade {
  UN
  G
  ML
}

enum TipoMovimento {
  ENTRADA
  SAIDA
  AJUSTE
}

enum OrigemMovimento {
  RECEITA
  DESPESA
  AJUSTE
  MANUAL
}

enum FormaPagamento {
  DINHEIRO
  PIX
  CARTAO_CREDITO
  CARTAO_DEBITO
  BOLETO
  OUTRO
}

enum PagamentoStatus {
  PENDENTE
  PARCIAL
  PAGO
  CANCELADO
}

model Usuario {
  id              String    @id @default(uuid())
  nome            String
  email           String    @unique
  senha           String
  cpf             String?
  celular         String?
  admin           Boolean   @default(false)
  vipLevel        Int       @default(0)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  produtos        Produto[]
  receitas        Receita[]
  despesas        Despesa[]
  clientes        Cliente[]

  @@map("usuarios")
}

model Produto {
  id           Int       @id @default(autoincrement())
  nome         String
  unidadeBase  Unidade
  categoria    String?
  margemPadrao Decimal?        @db.Decimal(5, 2)

  saldoBase    Decimal         @default(0) @db.Decimal(18, 6)
  custoMedio   Decimal         @default(0) @db.Decimal(14, 6)

  usuarioId    String
  usuario      Usuario  @relation(fields: [usuarioId], references: [id])

  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  itensReceita ReceitaItem[]
  itensMov     EstoqueMovItem[]

  @@index([nome])
}

model Cliente {
  id         Int       @id @default(autoincrement())
  nome       String
  endereco   String?
  telefone   String?
  notas      String?

  usuarioId  String
  usuario    Usuario @relation(fields: [usuarioId], references: [id])

  receitas   Receita[]

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([nome])
}

model Receita {
  id         Int       @id @default(autoincrement())
  descricao  String
  valor      Decimal    @db.Decimal(12,2)
  categoria  String?
  anexo      String?

  createdAt  DateTime @default(now())

  usuarioId  String
  usuario    Usuario @relation(fields: [usuarioId], references: [id])

  clienteId  Int?
  cliente    Cliente? @relation(fields: [clienteId], references: [id])

  itens      ReceitaItem[]
  recebimentos Recebimento[]

  @@index([createdAt])
  @@index([clienteId])
}

model ReceitaItem {
  id         Int      @id @default(autoincrement())
  receitaId  Int
  produtoId  Int

  qtdBase    Decimal  @db.Decimal(18,6)
  precoUnit  Decimal  @db.Decimal(14,6)
  subtotal   Decimal  @db.Decimal(12,2)

  receita    Receita  @relation(fields: [receitaId], references: [id], onDelete: Cascade)
  produto    Produto  @relation(fields: [produtoId], references: [id])

  @@index([receitaId])
  @@index([produtoId])
}

model Recebimento {
  id            Int              @id @default(autoincrement())
  receitaId     Int
  vencimento    DateTime?
  valorPrevisto Decimal          @db.Decimal(12,2)
  valorPago     Decimal?         @db.Decimal(12,2)
  pagamentoEm   DateTime?
  forma         FormaPagamento?
  status        PagamentoStatus  @default(PENDENTE)
  createdAt     DateTime         @default(now())

  receita       Receita          @relation(fields: [receitaId], references: [id], onDelete: Cascade)

  @@index([receitaId])
  @@index([status, vencimento])
}

model Despesa {
  id         Int       @id @default(autoincrement())
  descricao  String
  valor      Decimal   @db.Decimal(12,2)
  categoria  String?
  anexo      String?

  data       DateTime
  createdAt  DateTime @default(now())

  usuarioId  String
  usuario    Usuario @relation(fields: [usuarioId], references: [id])

  @@index([data])
}

model EstoqueMovimento {
  id         Int              @id @default(autoincrement())
  tipo       TipoMovimento
  origem     OrigemMovimento?
  origemId   Int?
  data       DateTime         @default(now())
  total      Decimal?         @db.Decimal(12,2)
  anexo      String?
  createdAt  DateTime         @default(now())

  itens      EstoqueMovItem[]

  @@index([tipo, data])
  @@index([origem, origemId])
}

model EstoqueMovItem {
  id          Int      @id @default(autoincrement())
  movimentoId Int
  produtoId   Int

  qtdBase     Decimal  @db.Decimal(18,6)
  custoUnit   Decimal? @db.Decimal(14,6)
  subtotal    Decimal? @db.Decimal(12,2)

  movimento   EstoqueMovimento @relation(fields: [movimentoId], references: [id], onDelete: Cascade)
  produto     Produto          @relation(fields: [produtoId], references: [id])

  @@index([movimentoId])
  @@index([produtoId])
}
